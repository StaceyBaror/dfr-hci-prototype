<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>DFR-HCI • Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h3 mb-0">DFR-HCI Dashboard</h1>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary btn-sm" href="/ui/upload">Upload</a>
      <a class="btn btn-outline-info btn-sm" href="/auth/token?role=analyst" target="_blank">Get Analyst Token</a>
    </div>
  </div>

  <p class="text-muted">
    Paste your analyst token and click <b>Load</b> to fetch metrics and recent detections.
    This token is required for protected endpoints like <code>/viz/*</code>, <code>/report/*</code>,
    <code>/report_pdf/*</code>, <code>/xai/*</code>, and <code>/xai/png/*</code>.
  </p>

  <!-- Token input + controls -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <label class="form-label" for="token">Analyst Token</label>
      <input id="token" type="text" class="form-control" placeholder='eyJhbGciOi... or {"token":"eyJ..."}'>
      <div class="mt-2 d-flex align-items-center gap-2">
        <button class="btn btn-primary" id="btn-load">
          <span class="spinner-border spinner-border-sm me-2 d-none" id="spinner"></span>
          Load
        </button>
        <button class="btn btn-outline-secondary" id="btn-clear">Clear</button>
      </div>

      <!-- Helpful hint when no token is set -->
      <div id="hint" class="alert alert-warning mt-3 d-none">
        No token detected. Click <b>Get Analyst Token</b> above, copy the token, paste it here, and press <b>Load</b>.
      </div>

      <div id="err" class="alert alert-danger mt-3 d-none" role="alert"></div>
    </div>
  </div>

  <!-- KPI cards -->
  <div class="row g-3">
    <div class="col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title">Totals</h5>
          <div class="display-6"><span id="tot">—</span></div>
          <div class="text-muted">Detections processed</div>
          <hr>
          <div class="display-6 text-danger"><span id="alrt">—</span></div>
          <div class="text-muted">Alerts raised</div>
        </div>
      </div>
    </div>
    <div class="col-md-8">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title">By Department</h5>
          <div class="table-responsive">
            <table class="table table-sm mb-0">
              <thead><tr><th>Dept</th><th>Total</th><th>Alerts</th></tr></thead>
              <tbody id="dept-rows"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Model Evaluation (metrics & confusion matrix) -->
  <div class="card shadow-sm mt-3">
    <div class="card-body">
      <h5 class="card-title">Model Evaluation</h5>
      <p class="text-muted small mb-2">
        These links expose the evaluation artefacts used in Chapter&nbsp;10 (precision, recall, F<sub>1</sub>, confusion matrix).
        Make sure you have obtained an analyst token first (the token must be sent as an Authorization header).
      </p>
      <div class="d-flex flex-wrap gap-2">
        <a class="btn btn-sm btn-outline-primary" href="/viz/metrics" target="_blank">
          Metrics JSON
        </a>
        <a class="btn btn-sm btn-outline-secondary" href="/viz/confusion.png" target="_blank">
          Confusion Matrix (PNG)
        </a>
      </div>
      <p class="text-muted small mt-2 mb-0">
        Right-click the confusion matrix PNG and save it for inclusion in your thesis.
      </p>
    </div>
  </div>

  <!-- Recent detections -->
  <div class="card shadow-sm mt-3">
    <div class="card-body">
      <h5 class="card-title">Recent Detections</h5>
      <ul id="recent-list" class="list-group"></ul>
    </div>
  </div>

  <p class="text-muted mt-4" id="server-time"></p>
</div>

<script>
(function() {
  const $ = (id) => document.getElementById(id);

  const elTot = $('tot'),
        elAlrt = $('alrt'),
        elDeptRows = $('dept-rows'),
        elRecent = $('recent-list'),
        elErr = $('err'),
        elHint = $('hint'),
        elToken = $('token'),
        elServerTime = $('server-time'),
        btnLoad = $('btn-load'),
        btnClear = $('btn-clear'),
        spinner = $('spinner');

  // --- Simple cookie helpers (no regex) ---
  function setCookie(name, value, seconds) {
    const maxAge = seconds || 0;
    document.cookie = name + '=' + encodeURIComponent(value) +
      '; path=/' +
      (maxAge ? '; max-age=' + maxAge : '') +
      '; SameSite=Lax';
  }

  function getCookie(name) {
    const parts = document.cookie.split(';');
    for (const part of parts) {
      const trimmed = part.trim();
      if (!trimmed) continue;
      const idx = trimmed.indexOf('=');
      const key = idx >= 0 ? trimmed.slice(0, idx) : trimmed;
      const val = idx >= 0 ? trimmed.slice(idx + 1) : '';
      if (key === name) {
        try {
          return decodeURIComponent(val);
        } catch (_) {
          return val;
        }
      }
    }
    return null;
  }

  function showError(msg) {
    elErr.textContent = msg;
    elErr.classList.remove('d-none');
  }
  function clearError() {
    elErr.classList.add('d-none');
    elErr.textContent = '';
  }
  function setHint(visible) {
    elHint.classList.toggle('d-none', !visible);
  }
  function setLoading(loading) {
    btnLoad.disabled = loading;
    if (loading) {
      spinner.classList.remove('d-none');
      btnLoad.setAttribute('aria-busy', 'true');
    } else {
      spinner.classList.add('d-none');
      btnLoad.removeAttribute('aria-busy');
    }
  }

  function parseTokenInput(s) {
    s = (s || '').trim();
    if (!s) return '';
    // Try JSON with { "token": "eyJ..." }
    try {
      const obj = JSON.parse(s);
      if (obj && typeof obj === 'object' && obj.token) return String(obj.token).trim();
    } catch (_) {}
    // Otherwise assume raw JWT
    return s;
  }

  async function fetchJSON(url, token) {
    const headers = {};
    if (token) headers['Authorization'] = 'Bearer ' + token;
    const res = await fetch(url, { headers });
    if (!res.ok) {
      const txt = await res.text();
      throw new Error(res.status + ' ' + res.statusText + ' — ' + txt);
    }
    return res.json();
  }

  function resetUI() {
    elTot.textContent = '—';
    elAlrt.textContent = '—';
    elDeptRows.innerHTML = '';
    elRecent.innerHTML = '';
    elServerTime.textContent = '';
  }

  // Build an LI for “Recent Detections” with Report / PDF / Generate XAI / View XAI
  function renderRecentItem(it, token) {
    const li = document.createElement('li');
    li.className = 'list-group-item d-flex justify-content-between align-items-center';
    const conf = (it.confidence ?? 0).toFixed(3);
    const tokenQS = token ? '?token=' + encodeURIComponent(token) : '';

    li.innerHTML =
      '<div>' +
        '<div><strong>' + it.artifact_id + '</strong> — ' + it.y_hat + ' (' + conf + ')</div>' +
        '<div class="text-muted small">' +
          (it.dept ?? '—') + ' • ' + (it.user ?? '—') + ' • ' + (it.ts ?? '—') +
        '</div>' +
      '</div>' +
      '<div class="d-flex flex-wrap gap-2">' +
        '<a class="btn btn-sm btn-outline-primary" target="_blank" ' +
           'href="/report/' + encodeURIComponent(it.artifact_id) + tokenQS + '">' +
          'Report (HTML)' +
        '</a>' +
        '<a class="btn btn-sm btn-outline-dark" target="_blank" ' +
           'href="/report_pdf/' + encodeURIComponent(it.artifact_id) + tokenQS + '">' +
          'PDF' +
        '</a>' +
        '<button type="button" ' +
                'class="btn btn-sm btn-outline-secondary btn-xai-gen" ' +
                'data-artifact-id="' + it.artifact_id + '">' +
          'Generate XAI' +
        '</button>' +
        '<a class="btn btn-sm btn-outline-success" target="_blank" ' +
           'href="/xai/png/' + encodeURIComponent(it.artifact_id) + tokenQS + '">' +
          'View XAI' +
        '</a>' +
      '</div>';
    return li;
  }

  async function loadAll() {
    clearError();
    resetUI();

    // 1) Token from input OR cookie fallback
    let token = parseTokenInput(elToken.value);
    if (!token) {
      const cookieToken = getCookie('auth_token');
      if (cookieToken) token = cookieToken;
    }

    if (!token || !token.includes('.')) {
      setHint(true);
      showError('Paste a valid JWT (or JSON with a "token" field).');
      return;
    }
    setHint(false);

    // 2) Persist token for 1 hour (so Report/XAI links work)
    setCookie('auth_token', token, 3600);

    setLoading(true);
    try {
      // Summary (protected)
      const summary = await fetchJSON('/viz/summary', token);
      elTot.textContent = summary.total ?? 0;
      elAlrt.textContent = summary.alerts ?? 0;

      elDeptRows.innerHTML = '';
      const by = summary.by_dept || {};
      Object.keys(by).sort().forEach(dept => {
        const vals = by[dept] || {};
        const tr = document.createElement('tr');
        tr.innerHTML =
          '<td>' + dept + '</td>' +
          '<td>' + (vals.total ?? 0) + '</td>' +
          '<td>' + (vals.alerts ?? 0) + '</td>';
        elDeptRows.appendChild(tr);
      });

      // Recent (protected)
      const recent = await fetchJSON('/viz/recent?limit=10', token);
      elRecent.innerHTML = '';
      (recent.items || []).forEach(it => elRecent.appendChild(renderRecentItem(it, token)));

      // Server time (public)
      const rootRes = await fetchJSON('/', null);
      elServerTime.textContent = 'Server time (UTC): ' + (rootRes.time || '—');
    } catch (err) {
      showError(err.message || String(err));
    } finally {
      setLoading(false);
    }
  }

  // Wire up UI
  btnLoad.addEventListener('click', loadAll);
  btnClear.addEventListener('click', () => {
    elToken.value = '';
    setCookie('auth_token', '', 0);  // clear
    clearError();
    setHint(true);
    resetUI();
  });

  // Delegate click for “Generate XAI” buttons
  elRecent.addEventListener('click', async (ev) => {
    const btn = ev.target.closest('.btn-xai-gen');
    if (!btn) return;

    clearError();

    // Get token again (from input or cookie)
    let token = parseTokenInput(elToken.value) || getCookie('auth_token');
    if (!token || !token.includes('.')) {
      showError('Paste a valid analyst token before generating XAI.');
      return;
    }

    const artifactId = btn.getAttribute('data-artifact-id');
    btn.disabled = true;
    const originalText = btn.textContent;
    btn.textContent = 'Generating…';

    try {
      const res = await fetch('/xai/' + encodeURIComponent(artifactId), {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      if (!res.ok) {
        const txt = await res.text();
        throw new Error(res.status + ' ' + res.statusText + ' — ' + txt);
      }
    } catch (e) {
      showError('XAI generation failed: ' + (e.message || String(e)));
    } finally {
      btn.disabled = false;
      btn.textContent = originalText;
    }
  });

  // On load, if a cookie exists, prefill the token box (nice UX)
  const cookieToken = getCookie('auth_token');
  if (cookieToken) {
    elToken.value = cookieToken;
    setHint(false);
  } else {
    setHint(true);
  }

  // Re-enable Load if user navigates back to this page
  window.addEventListener('pageshow', () => setLoading(false));
})();
</script>
</body>
</html>