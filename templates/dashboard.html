<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>DFR-HCI • Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h3 mb-0">DFR-HCI Dashboard</h1>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary btn-sm" href="/ui/upload">Upload</a>
      <a class="btn btn-outline-info btn-sm" href="/auth/token?role=analyst" target="_blank">Get Analyst Token</a>
    </div>
  </div>
  <p class="text-muted">Paste your analyst token and click <b>Load</b> to fetch metrics and recent detections.</p>

  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <label class="form-label" for="token">Analyst Token</label>
      <input id="token" type="text" class="form-control" placeholder='eyJhbGciOi... or {"token":"eyJ..."}'>
      <div class="mt-2 d-flex align-items-center gap-2">
        <button class="btn btn-primary" id="btn-load">
          <span class="spinner-border spinner-border-sm me-2 d-none" id="spinner"></span>
          Load
        </button>
        <button class="btn btn-outline-secondary" id="btn-clear">Clear</button>
      </div>
      <div id="err" class="alert alert-danger mt-3 d-none" role="alert"></div>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title">Totals</h5>
          <div class="display-6"><span id="tot">—</span></div>
          <div class="text-muted">Detections processed</div>
          <hr>
          <div class="display-6 text-danger"><span id="alrt">—</span></div>
          <div class="text-muted">Alerts raised</div>
        </div>
      </div>
    </div>
    <div class="col-md-8">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title">By Department</h5>
          <div class="table-responsive">
            <table class="table table-sm mb-0">
              <thead><tr><th>Dept</th><th>Total</th><th>Alerts</th></tr></thead>
              <tbody id="dept-rows"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm mt-3">
    <div class="card-body">
      <h5 class="card-title">Recent Detections</h5>
      <ul id="recent-list" class="list-group"></ul>
    </div>
  </div>

  <p class="text-muted mt-4" id="server-time"></p>
</div>

<script>
(function() {
  const $ = (id) => document.getElementById(id);

  const elTot = $('tot'),
        elAlrt = $('alrt'),
        elDeptRows = $('dept-rows'),
        elRecent = $('recent-list'),
        elErr = $('err'),
        elToken = $('token'),
        elServerTime = $('server-time'),
        btnLoad = $('btn-load'),
        btnClear = $('btn-clear'),
        spinner = $('spinner');

  function showError(msg) {
    elErr.textContent = msg;
    elErr.classList.remove('d-none');
  }
  function clearError() {
    elErr.classList.add('d-none');
    elErr.textContent = '';
  }
  function setLoading(loading) {
    btnLoad.disabled = loading;
    if (loading) {
      spinner.classList.remove('d-none');
      btnLoad.setAttribute('aria-busy', 'true');
    } else {
      spinner.classList.add('d-none');
      btnLoad.removeAttribute('aria-busy');
    }
  }
  function parseTokenInput(s) {
    s = (s || '').trim();
    try {
      const obj = JSON.parse(s);
      if (obj && typeof obj === 'object' && obj.token) return obj.token;
    } catch (_) {}
    return s; // assume raw JWT
  }
  async function fetchJSON(url, token) {
    const res = await fetch(url, {
      headers: token ? { 'Authorization': 'Bearer ' + token } : {}
    });
    if (!res.ok) {
      const txt = await res.text();
      throw new Error(res.status + ' ' + res.statusText + ' — ' + txt);
    }
    return res.json();
  }
  function resetUI() {
    elTot.textContent = '—';
    elAlrt.textContent = '—';
    elDeptRows.innerHTML = '';
    elRecent.innerHTML = '';
    elServerTime.textContent = '';
  }

  async function loadAll() {
    clearError();
    resetUI();
    const token = parseTokenInput(elToken.value);
    if (!token || !token.includes('.')) { showError('Paste a valid JWT (or JSON with a "token" field).'); return; }

    setLoading(true);
    try {
      const summary = await fetchJSON('/viz/summary', token);
      elTot.textContent = summary.total ?? 0;
      elAlrt.textContent = summary.alerts ?? 0;

      elDeptRows.innerHTML = '';
      const by = summary.by_dept || {};
      Object.keys(by).sort().forEach(dept => {
        const vals = by[dept] || {};
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${dept}</td><td>${vals.total ?? 0}</td><td>${vals.alerts ?? 0}</td>`;
        elDeptRows.appendChild(tr);
      });

      const recent = await fetchJSON('/viz/recent?limit=10', token);
      elRecent.innerHTML = '';
      (recent.items || []).forEach(it => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        const conf = (it.confidence ?? 0).toFixed(3);
        li.innerHTML =
          `<div>
             <div><strong>${it.artifact_id}</strong> — ${it.y_hat} (${conf})</div>
             <div class="text-muted small">${it.dept ?? '—'} • ${it.user ?? '—'} • ${it.ts ?? '—'}</div>
           </div>
           <a class="btn btn-sm btn-outline-primary" href="/report/${it.artifact_id}" target="_blank">Report</a>`;
        elRecent.appendChild(li);
      });

      const rootRes = await fetchJSON('/', null);
      elServerTime.textContent = `Server time (UTC): ${rootRes.time || '—'}`;
    } catch (err) {
      showError(err.message || String(err));
    } finally {
      setLoading(false);
    }
  }

  btnLoad.addEventListener('click', loadAll);
  btnClear.addEventListener('click', () => {
    elToken.value = '';
    clearError();
    resetUI();
  });

  // Re-enable Load if user navigates back to this page
  window.addEventListener('pageshow', () => setLoading(false));
})();
</script>
</body>
</html>
